name: ‚ôüÔ∏è Chess Game

on:
  workflow_dispatch:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  validate-move:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened' && startsWith(github.event.issue.title, 'chess|')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install python-chess
      
      - name: Initialize game if needed
        run: |
          if [ ! -f chess_board.svg ]; then
            python chess_game.py init
          fi
      
      - name: Validate Move
        id: validate
        run: |
          MOVE=$(echo "${{ github.event.issue.title }}" | sed 's/chess|//')
          echo "move=$MOVE" >> $GITHUB_OUTPUT
          
          # Testa se a jogada √© v√°lida
          if python chess_game.py move "$MOVE" --dry-run 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment - Valid Move
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const move = '${{ steps.validate.outputs.move }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Jogada v√°lida!**\n\nüéØ Jogada: \`${move}\`\n\n‚è≥ Aguardando aprova√ß√£o do @EdderGaddini para executar a jogada!\n\n---\nüí° *Assim que aprovada, o tabuleiro ser√° atualizado automaticamente.*`
            })
            
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['chess-move', 'awaiting-approval']
            })
      
      - name: Comment - Invalid Move
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const move = '${{ steps.validate.outputs.move }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Jogada inv√°lida!**\n\nüéØ Jogada tentada: \`${move}\`\n\n‚ö†Ô∏è Esta jogada n√£o √© permitida no estado atual do jogo.\n\n---\nüìñ Confira as [regras e formato correto](../blob/main/CHESS_INSTRUCTIONS.md)!`
            })
            
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })

  execute-move:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled' && 
      github.event.label.name == 'approved' &&
      startsWith(github.event.issue.title, 'chess|')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install python-chess
      
      - name: Execute Move
        id: move
        run: |
          MOVE=$(echo "${{ github.event.issue.title }}" | sed 's/chess|//')
          echo "move=$MOVE" >> $GITHUB_OUTPUT
          
          if python chess_game.py move "$MOVE"; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Get game status
        id: status
        run: |
          STATUS=$(python chess_game.py status)
          echo "status<<EOF" >> $GITHUB_OUTPUT
          echo "$STATUS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Pega o pr√≥ximo turno
          TURN=$(echo "$STATUS" | grep "Turno:" | cut -d: -f2 | xargs)
          echo "turn=$TURN" >> $GITHUB_OUTPUT
          
          MOVE_NUM=$(echo "$STATUS" | grep "Jogadas:" | cut -d: -f2 | xargs)
          echo "move_number=$MOVE_NUM" >> $GITHUB_OUTPUT
      
      - name: Update README with game state
        run: |
          TURN="${{ steps.status.outputs.turn }}"
          MOVE_NUM="${{ steps.status.outputs.move_number }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Atualiza o turno e n√∫mero da jogada usando Python
          python << EOF
          import re
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Atualiza turno e jogada
          content = re.sub(
              r'<b>Turno atual:</b> .* \| <b>Jogada:</b> .*',
              f'<b>Turno atual:</b> $TURN | <b>Jogada:</b> $MOVE_NUM',
              content
          )
          
          # Atualiza timestamp
          content = re.sub(
              r'√öltima atualiza√ß√£o: .*',
              f'√öltima atualiza√ß√£o: $TIMESTAMP',
              content
          )
          
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(content)
          EOF
      
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add chess.pgn chess_board.svg README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "‚ôüÔ∏è Jogada executada: ${{ steps.move.outputs.move }}"
          git push
      
      - name: Comment success
        if: steps.move.outputs.success == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const status = `${{ steps.status.outputs.status }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üéâ **Jogada executada com sucesso!**\n\n${status}\n\n---\n‚ú® [Confira o tabuleiro atualizado!](../blob/main/README.md)`
            })
            
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })
            
            github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'awaiting-approval'
            })


